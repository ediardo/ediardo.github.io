<div id="photos-overlay" class="photos-overlay" role="dialog" aria-modal="true" aria-label="Image viewer" hidden>
  <button type="button" class="photos-overlay-close" aria-label="Close">&times;</button>
  <button type="button" class="photos-overlay-prev" aria-label="Previous image">&#10094;</button>
  <button type="button" class="photos-overlay-next" aria-label="Next image">&#10095;</button>
  <a class="photos-overlay-download" aria-label="Download image" download>&#8681; Download</a>
  <div class="photos-overlay-inner">
    <img src="" alt="" />
  </div>
</div>

<style>
.gallery-photo-trigger { cursor: zoom-in; display: block; }
.gallery-photo-trigger img { display: block; width: 100%; height: auto; margin: 0 !important; border-radius: 0 !important; }
.photos-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  box-sizing: border-box;
  touch-action: none;
  overflow: hidden;
}
.photos-overlay[hidden] { display: none !important; }
.photos-overlay-inner {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  touch-action: none;
}
.photos-overlay-inner img {
  width: 100%;
  max-height: none;
  height: auto;
  object-fit: contain;
  user-select: none;
  -webkit-user-drag: none;
  transform-origin: center center;
  transition: transform 0.2s ease-out;
}
.photos-overlay-inner img.zooming {
  transition: none;
}
.photos-overlay-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 1.75rem;
  line-height: 1;
  cursor: pointer;
  border-radius: 4px;
  z-index: 20;
}
.photos-overlay-close:hover { background: rgba(255, 255, 255, 0.25); }
.photos-overlay-prev,
.photos-overlay-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 2rem;
  height: 2rem;
  padding: 0;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 1rem;
  line-height: 1;
  cursor: pointer;
  border-radius: 4px;
  z-index: 20;
}
.photos-overlay-prev { left: 1rem; }
.photos-overlay-next { right: 1rem; }
.photos-overlay-prev:hover,
.photos-overlay-next:hover { background: rgba(255, 255, 255, 0.25); }
.photos-overlay-download {
  position: absolute;
  top: 1rem;
  right: 4rem;
  height: 2.5rem;
  padding: 0 0.75rem;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 1rem;
  line-height: 2.5rem;
  text-align: center;
  text-decoration: none;
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.25rem;
  z-index: 20;
}
.photos-overlay-download:hover { background: rgba(255, 255, 255, 0.25); }
@media (max-width: 768px) {
  .photos-overlay-prev,
  .photos-overlay-next {
    width: 1.75rem;
    height: 1.75rem;
    font-size: 0.875rem;
  }
  .photos-overlay-prev { left: 0.5rem; }
  .photos-overlay-next { right: 0.5rem; }
}
</style>

<script>
(function() {
  var overlay = document.getElementById('photos-overlay');
  if (!overlay) return;
  var img = overlay.querySelector('.photos-overlay-inner img');
  var inner = overlay.querySelector('.photos-overlay-inner');
  var closeBtn = overlay.querySelector('.photos-overlay-close');
  var prevBtn = overlay.querySelector('.photos-overlay-prev');
  var nextBtn = overlay.querySelector('.photos-overlay-next');
  var downloadBtn = overlay.querySelector('.photos-overlay-download');

  var triggers = [];
  var currentIndex = -1;

  var scale = 1;
  var translateX = 0;
  var translateY = 0;
  var lastTapTime = 0;
  var initialPinchDistance = 0;
  var initialScale = 1;
  var isPinching = false;
  var panStartX = 0;
  var panStartY = 0;
  var initialTranslateX = 0;
  var initialTranslateY = 0;
  var isPanning = false;

  function collectTriggers() {
    triggers = Array.prototype.slice.call(document.querySelectorAll('.gallery-photo-trigger'));
  }

  function resetZoom() {
    scale = 1;
    translateX = 0;
    translateY = 0;
    img.classList.remove('zooming');
    updateTransform();
  }

  function updateTransform() {
    img.style.transform = 'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + scale + ')';
  }

  function open(index) {
    if (index < 0 || index >= triggers.length) return;
    currentIndex = index;
    var trigger = triggers[index];
    var src = trigger.getAttribute('data-full');
    var alt = (trigger.querySelector('img') && trigger.querySelector('img').alt) || '';
    img.src = src;
    img.alt = alt;
    downloadBtn.href = src;
    downloadBtn.download = src.split('/').pop();
    resetZoom();
    overlay.hidden = false;
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.top = '-' + window.scrollY + 'px';
    updateNavButtons();
  }

  function close() {
    var scrollY = document.body.style.top;
    overlay.hidden = true;
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
    document.body.style.top = '';
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
    resetZoom();
    currentIndex = -1;
  }

  function prev() {
    if (scale > 1) return;
    if (currentIndex > 0) open(currentIndex - 1);
  }

  function next() {
    if (scale > 1) return;
    if (currentIndex < triggers.length - 1) open(currentIndex + 1);
  }

  function updateNavButtons() {
    prevBtn.style.visibility = currentIndex > 0 ? 'visible' : 'hidden';
    nextBtn.style.visibility = currentIndex < triggers.length - 1 ? 'visible' : 'hidden';
  }

  document.addEventListener('click', function(e) {
    var trigger = e.target.closest('.gallery-photo-trigger');
    if (trigger) {
      e.preventDefault();
      collectTriggers();
      var index = triggers.indexOf(trigger);
      open(index);
    }
  });

  closeBtn.addEventListener('click', close);
  prevBtn.addEventListener('click', function(e) { e.stopPropagation(); prev(); });
  nextBtn.addEventListener('click', function(e) { e.stopPropagation(); next(); });

  document.addEventListener('keydown', function(e) {
    if (overlay.hidden) return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight') next();
  });

  function getDistance(touches) {
    var dx = touches[0].clientX - touches[1].clientX;
    var dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function getMidpoint(touches) {
    return {
      x: (touches[0].clientX + touches[1].clientX) / 2,
      y: (touches[0].clientY + touches[1].clientY) / 2
    };
  }

  var touchStartX = 0;
  var touchStartY = 0;
  var touchStartTime = 0;
  var isSingleTouch = false;
  var touchThreshold = 80;
  var maxVerticalDrift = 100;
  var maxSwipeTime = 400;

  inner.addEventListener('touchstart', function(e) {
    if (e.touches.length === 2) {
      isPinching = true;
      isPanning = false;
      isSingleTouch = false;
      initialPinchDistance = getDistance(e.touches);
      initialScale = scale;
      img.classList.add('zooming');
    } else if (e.touches.length === 1) {
      var now = Date.now();
      if (now - lastTapTime < 300) {
        if (scale > 1) {
          resetZoom();
        } else {
          scale = 2.5;
          var rect = inner.getBoundingClientRect();
          var tapX = e.touches[0].clientX - rect.left - rect.width / 2;
          var tapY = e.touches[0].clientY - rect.top - rect.height / 2;
          translateX = -tapX * 0.6;
          translateY = -tapY * 0.6;
          updateTransform();
        }
        lastTapTime = 0;
        e.preventDefault();
        return;
      }
      lastTapTime = now;

      if (scale > 1) {
        isPanning = true;
        panStartX = e.touches[0].clientX;
        panStartY = e.touches[0].clientY;
        initialTranslateX = translateX;
        initialTranslateY = translateY;
        img.classList.add('zooming');
      } else {
        isSingleTouch = true;
        touchStartX = e.touches[0].screenX;
        touchStartY = e.touches[0].screenY;
        touchStartTime = Date.now();
      }
    }
  }, { passive: false });

  inner.addEventListener('touchmove', function(e) {
    if (isPinching && e.touches.length === 2) {
      e.preventDefault();
      var newDistance = getDistance(e.touches);
      var newScale = initialScale * (newDistance / initialPinchDistance);
      scale = Math.max(1, Math.min(newScale, 5));
      if (scale === 1) {
        translateX = 0;
        translateY = 0;
      }
      updateTransform();
    } else if (isPanning && e.touches.length === 1) {
      e.preventDefault();
      var dx = e.touches[0].clientX - panStartX;
      var dy = e.touches[0].clientY - panStartY;
      translateX = initialTranslateX + dx;
      translateY = initialTranslateY + dy;
      updateTransform();
    } else if (e.touches.length > 1) {
      isSingleTouch = false;
    }
  }, { passive: false });

  inner.addEventListener('touchend', function(e) {
    if (isPinching) {
      isPinching = false;
      img.classList.remove('zooming');
      if (scale <= 1) {
        resetZoom();
      }
      return;
    }
    if (isPanning) {
      isPanning = false;
      img.classList.remove('zooming');
      return;
    }
    if (!isSingleTouch || scale > 1) return;
    var touchEndX = e.changedTouches[0].screenX;
    var touchEndY = e.changedTouches[0].screenY;
    var touchEndTime = Date.now();
    var diffX = touchEndX - touchStartX;
    var diffY = Math.abs(touchEndY - touchStartY);
    var elapsed = touchEndTime - touchStartTime;
    if (Math.abs(diffX) > touchThreshold && diffY < maxVerticalDrift && elapsed < maxSwipeTime) {
      if (diffX > 0) prev();
      else next();
    }
  }, { passive: true });

  overlay.addEventListener('wheel', function(e) {
    if (overlay.hidden) return;
    e.preventDefault();
    var delta = e.deltaY > 0 ? 0.9 : 1.1;
    var newScale = scale * delta;
    scale = Math.max(1, Math.min(newScale, 5));
    if (scale === 1) {
      translateX = 0;
      translateY = 0;
    }
    updateTransform();
  }, { passive: false });
})();
</script>
